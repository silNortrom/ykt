<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ykt.backstage.dao.LostWarningsMapper">
    <cache type="com.ykt.backstage.common.config.MybatisRedisCache">
        <property name="eviction" value="LRU"/>
        <property name="flushInterval" value="6000000"/>
        <property name="size" value="1024"/>
        <property name="readOnly" value="false"/>
    </cache>
    <resultMap id="BaseResultMap" type="com.ykt.backstage.entity.LostWarnings">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="sno" jdbcType="VARCHAR" property="sno"/>
        <result column="sname" jdbcType="VARCHAR" property="sname"/>
        <result column="gender_code" jdbcType="CHAR" property="genderCode"/>
        <result column="stu_type" jdbcType="VARCHAR" property="stuType"/>
        <result column="class_name" jdbcType="VARCHAR" property="className"/>
        <result column="class_no" jdbcType="VARCHAR" property="classNo"/>
        <result column="major_code" jdbcType="VARCHAR" property="majorCode"/>
        <result column="major_name" jdbcType="VARCHAR" property="majorName"/>
        <result column="department_code" jdbcType="VARCHAR" property="departmentCode"/>
        <result column="department_name" jdbcType="VARCHAR" property="departmentName"/>
        <result column="wno" jdbcType="VARCHAR" property="wno"/>
        <result column="wname" jdbcType="VARCHAR" property="wname"/>
        <result column="grade" jdbcType="VARCHAR" property="grade"/>
        <result column="created_at" jdbcType="TIMESTAMP" property="createdAt"/>
        <result column="updated_at" jdbcType="TIMESTAMP" property="updatedAt"/>
        <result column="w_department_code" jdbcType="VARCHAR" property="wDepartmentCode"/>
        <result column="school_year" jdbcType="VARCHAR" property="schoolYear"/>
        <result column="school_term" jdbcType="VARCHAR" property="schoolTerm"/>
        <result column="last_action_type" jdbcType="CHAR" property="lastActionType"/>
        <result column="last_action_location" jdbcType="VARCHAR" property="lastActionLocation"/>
        <result column="last_action_time" jdbcType="TIMESTAMP" property="lastActionTime"/>
    </resultMap>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from lost_warnings
        where id = #{id,jdbcType=INTEGER}
    </delete>
    <insert id="insert" parameterType="com.ykt.backstage.entity.LostWarnings">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into lost_warnings (sno, sname, gender_code,
        stu_type, class_name, class_no,
        major_code, major_name, department_code,
        department_name, wno, wname,
        grade, created_at, updated_at,
        w_department_code, school_year, school_term,
        last_action_type, last_action_location, last_action_time
        )
        values (#{sno,jdbcType=VARCHAR}, #{sname,jdbcType=VARCHAR}, #{genderCode,jdbcType=CHAR},
        #{stuType,jdbcType=VARCHAR}, #{className,jdbcType=VARCHAR}, #{classNo,jdbcType=VARCHAR},
        #{majorCode,jdbcType=VARCHAR}, #{majorName,jdbcType=VARCHAR}, #{departmentCode,jdbcType=VARCHAR},
        #{departmentName,jdbcType=VARCHAR}, #{wno,jdbcType=VARCHAR}, #{wname,jdbcType=VARCHAR},
        #{grade,jdbcType=VARCHAR}, #{createdAt,jdbcType=TIMESTAMP}, #{updatedAt,jdbcType=TIMESTAMP},
        #{wDepartmentCode,jdbcType=VARCHAR}, #{schoolYear,jdbcType=VARCHAR}, #{schoolTerm,jdbcType=VARCHAR},
        #{lastActionType,jdbcType=CHAR}, #{lastActionLocation,jdbcType=VARCHAR}, #{lastActionTime,jdbcType=TIMESTAMP}
        )
    </insert>
    <update id="updateByPrimaryKey" parameterType="com.ykt.backstage.entity.LostWarnings">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update lost_warnings
        set sno = #{sno,jdbcType=VARCHAR},
        sname = #{sname,jdbcType=VARCHAR},
        gender_code = #{genderCode,jdbcType=CHAR},
        stu_type = #{stuType,jdbcType=VARCHAR},
        class_name = #{className,jdbcType=VARCHAR},
        class_no = #{classNo,jdbcType=VARCHAR},
        major_code = #{majorCode,jdbcType=VARCHAR},
        major_name = #{majorName,jdbcType=VARCHAR},
        department_code = #{departmentCode,jdbcType=VARCHAR},
        department_name = #{departmentName,jdbcType=VARCHAR},
        wno = #{wno,jdbcType=VARCHAR},
        wname = #{wname,jdbcType=VARCHAR},
        grade = #{grade,jdbcType=VARCHAR},
        created_at = #{createdAt,jdbcType=TIMESTAMP},
        updated_at = #{updatedAt,jdbcType=TIMESTAMP},
        w_department_code = #{wDepartmentCode,jdbcType=VARCHAR},
        school_year = #{schoolYear,jdbcType=VARCHAR},
        school_term = #{schoolTerm,jdbcType=VARCHAR},
        last_action_type = #{lastActionType,jdbcType=CHAR},
        last_action_location = #{lastActionLocation,jdbcType=VARCHAR},
        last_action_time = #{lastActionTime,jdbcType=TIMESTAMP}
        where id = #{id,jdbcType=INTEGER}
    </update>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select id, sno, sname, gender_code, stu_type, class_name, class_no, major_code, major_name,
        department_code, department_name, wno, wname, grade, created_at, updated_at, w_department_code,
        school_year, school_term, last_action_type, last_action_location, last_action_time
        from lost_warnings
        where id = #{id,jdbcType=INTEGER}
    </select>
    <select id="selectAll" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select id, sno, sname, gender_code, stu_type, class_name, class_no, major_code, major_name,
        department_code, department_name, wno, wname, grade, created_at, updated_at, w_department_code,
        school_year, school_term, last_action_type, last_action_location, last_action_time
        from lost_warnings
    </select>

    <!-- 分页查询 -->
    <select id="pageQuery" resultMap="BaseResultMap">
        select *
        from lost_warnings
        <bind name="offset" value="(query.pn-1)*query.ps"></bind>
        limit #{offset},#{query.ps}
    </select>

    <!-- 返回当月预警数 -->
    <select id="monthWarning" resultType="com.ykt.backstage.VO.LostWarningsVO">
        select a.id,a.sname as xm,a.sno as xh,a.department_name as xy,a.major_name as
        zy,DATE_FORMAT(a.created_at,'%Y-%m-%d') as yjsj,IFNULL(DATE_FORMAT(b.feedback_time,'%Y-%m-%d'),'none') as jcyjsj
        from lost_warnings as a LEFT JOIN (select * from feedback_records where type = 'lost') as b ON a.id =
        b.attendance_warnings_id where DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= date(a.created_at)
    </select>
    <!-- 返回今日新增预警预警数 -->
    <select id="dayNewWarning" resultType="com.ykt.backstage.VO.LostWarningsVO">
        select a.id,a.sname as xm,a.sno as xh,a.department_name as xy,a.major_name as
        zy,DATE_FORMAT(a.created_at,'%Y-%m-%d') as yjsj,DATE_FORMAT(b.feedback_time,'%Y-%m-%d') as jcyjsj from
        lost_warnings as a LEFT JOIN (select * from feedback_records where type = 'lost') as b ON a.id =
        b.attendance_warnings_id where DATE_FORMAT(CURDATE(),'%Y-%m-%d') = DATE_FORMAT(a.created_at,'%Y-%m-%d')
    </select>
    <!-- 返回当月折线图数据 -->
    <select id="monthLineWarning" resultType="map">
        select DATE_FORMAT(created_at,'%Y-%m-%d') as sj,COUNT(created_at) as yjs
        from lost_warnings where DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= date(created_at) group by
        DATE_FORMAT(created_at,'%Y-%m-%d')
    </select>
    <!-- 返回当月柱状图数据 -->
    <select id="monthHistogramWarning" resultType="com.ykt.backstage.VO.LostHistogramVO">
        select department_name as xy,count(department_name) as yjs,count(attendance_warnings_id) as jcyjs from
        lost_warnings as a LEFT JOIN (select * from feedback_records where type = 'lost') as b on a.id =
        b.attendance_warnings_id where DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= date(a.created_at) GROUP BY
        department_name
    </select>

    <insert id="addFeedbacks" parameterType="com.ykt.backstage.entity.FeedbackRecords" useGeneratedKeys="true"
            keyProperty="id">
        insert into feedback_records (
        attendance_warnings_id,
        feedback_time,
        created_by,
        created_user_id,
        created_at,
        description,
        type
        ) values (
        #{attendanceWarningsId},
        #{feedbackTime},
        #{createdBy},
        #{createdUserId},
        #{feedbackTime},
        #{description},
        #{type}
        )
    </insert>
</mapper>