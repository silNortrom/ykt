<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ykt.backstage.dao.DormitoryWarningMapper">
    <cache type="com.ykt.backstage.common.config.MybatisRedisCache">
        <property name="eviction" value="LRU"/>
        <property name="flushInterval" value="6000000"/>
        <property name="size" value="1024"/>
        <property name="readOnly" value="false"/>
    </cache>
    <resultMap id="BaseResultMap" type="com.ykt.backstage.entity.DormitoryWarning">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="xm" jdbcType="VARCHAR" property="xm"/>
        <result column="xh" jdbcType="VARCHAR" property="xh"/>
        <result column="xb" jdbcType="VARCHAR" property="xb"/>
        <result column="rxnj" jdbcType="VARCHAR" property="rxnj"/>
        <result column="bjdm" jdbcType="VARCHAR" property="bjdm"/>
        <result column="zydm" jdbcType="VARCHAR" property="zydm"/>
        <result column="ssfjh" jdbcType="VARCHAR" property="ssfjh"/>
        <result column="jzwh" jdbcType="VARCHAR" property="jzwh"/>
        <result column="warning_time" jdbcType="TIMESTAMP" property="warningTime"/>
        <result column="created_at" jdbcType="TIMESTAMP" property="createdAt"/>
        <result column="update_at" jdbcType="TIMESTAMP" property="updateAt"/>
        <result column="xjzt" jdbcType="VARCHAR" property="xjzt"/>
        <result column="yxdm" jdbcType="VARCHAR" property="yxdm"/>
        <result column="xz" jdbcType="VARCHAR" property="xz"/>
        <result column="zhcxsj" jdbcType="TIMESTAMP" property="zhcxsj"/>
    </resultMap>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from dormitory_warning
        where id = #{id,jdbcType=INTEGER}
    </delete>
    <insert id="insert" parameterType="com.ykt.backstage.entity.DormitoryWarning">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into dormitory_warning (xm,xh, xb, rxnj,
        bjdm, zydm, ssfjh,
        jzwh, warning_time, created_at,
        update_at, xjzt, yxdm,
        xz, zhcxsj)
        values (#{xm,jdbcType=VARCHAR},#{xh,jdbcType=VARCHAR}, #{xb,jdbcType=VARCHAR}, #{rxnj,jdbcType=VARCHAR},
        #{bjdm,jdbcType=VARCHAR}, #{zydm,jdbcType=VARCHAR}, #{ssfjh,jdbcType=VARCHAR},
        #{jzwh,jdbcType=VARCHAR}, #{warningTime,jdbcType=TIMESTAMP}, #{createdAt,jdbcType=TIMESTAMP},
        #{updateAt,jdbcType=TIMESTAMP}, #{xjzt,jdbcType=VARCHAR}, #{yxdm,jdbcType=VARCHAR},
        #{xz,jdbcType=VARCHAR}, #{zhcxsj,jdbcType=TIMESTAMP})
    </insert>
    <update id="updateByPrimaryKey" parameterType="com.ykt.backstage.entity.DormitoryWarning">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update dormitory_warning
        set xm = #{xm,jdbcType=VARCHAR},
        xh = #{xh,jdbcType=VARCHAR},
        xb = #{xb,jdbcType=VARCHAR},
        rxnj = #{rxnj,jdbcType=VARCHAR},
        bjdm = #{bjdm,jdbcType=VARCHAR},
        zydm = #{zydm,jdbcType=VARCHAR},
        ssfjh = #{ssfjh,jdbcType=VARCHAR},
        jzwh = #{jzwh,jdbcType=VARCHAR},
        warning_time = #{warningTime,jdbcType=TIMESTAMP},
        created_at = #{createdAt,jdbcType=TIMESTAMP},
        update_at = #{updateAt,jdbcType=TIMESTAMP},
        xjzt = #{xjzt,jdbcType=VARCHAR},
        yxdm = #{yxdm,jdbcType=VARCHAR},
        xz = #{xz,jdbcType=VARCHAR},
        zhcxsj = #{zhcxsj,jdbcType=TIMESTAMP}
        where id = #{id,jdbcType=INTEGER}
    </update>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select id, xm, xh, xb, rxnj, bjdm, zydm, ssfjh, jzwh, warning_time, created_at, update_at,
        xjzt, yxdm, xz, zhcxsj
        from dormitory_warning
        where id = #{id,jdbcType=INTEGER}
    </select>
    <select id="selectAll" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select id, xm, xh, xb, rxnj, bjdm, zydm, ssfjh, jzwh, warning_time, created_at, update_at,
        xjzt, yxdm, xz, zhcxsj
        from dormitory_warning
    </select>

    <!-- 分页查询 -->
    <select id="pageQuery" resultMap="BaseResultMap">
        select *
        from dormitory_warning
        <bind name="offset" value="(query.pn-1)*query.ps"></bind>
        limit #{offset},#{query.ps}
    </select>

    <!-- 获取当月数据 -->
    <select id="getMonthData" resultType="com.ykt.backstage.VO.DormitoryWarningVO">
        select a.id,a.xm,a.xh,DATE_FORMAT(a.zhcxsj,'%Y-%m-%d'),DATE_FORMAT(a.warning_time,'%Y-%m-%d') as
        yjsj,IFNULL(DATE_FORMAT(b.feedback_time,'%Y-%m-%d'),'none') jcyjsj from dormitory_warning a LEFT JOIN (select *
        from feedback_records where type = 'dormitory') b on a.id = b.attendance_warnings_id where DATE_SUB(CURDATE(),
        INTERVAL 30 DAY) &lt;= date(a.created_at)
    </select>
    <!-- 获取当日数据 -->
    <select id="getTodayData" resultType="com.ykt.backstage.VO.DormitoryWarningVO">
        select a.id,a.xm,a.xh,DATE_FORMAT(a.zhcxsj,'%Y-%m-%d'),DATE_FORMAT(a.warning_time,'%Y-%m-%d') as
        yjsj,IFNULL(DATE_FORMAT(b.feedback_time,'%Y-%m-%d'),'none') jcyjsj from dormitory_warning a LEFT JOIN (select *
        from feedback_records where type = 'dormitory') b on a.id = b.attendance_warnings_id where
        DATE_FORMAT(CURDATE(),'%Y-%m-%d') = DATE_FORMAT(a.created_at,'%Y-%m-%d')
    </select>

    <!-- 返回当月折线图 -->
    <select id="monthLineWarning" resultType="map">
        select DATE_FORMAT(created_at,'%Y-%m-%d') as sj,COUNT(created_at) as yjs
        from dormitory_warning where DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= date(created_at) group by
        DATE_FORMAT(created_at,'%Y-%m-%d')
    </select>

    <!-- 返回当月柱状图数据 -->
    <select id="monthHistogramWarning" resultType="com.ykt.backstage.VO.LostHistogramVO">
        select yxdm as xy,count(yxdm) as yjs,count(attendance_warnings_id) as jcyjs from dormitory_warning as a LEFT
        JOIN (select * from feedback_records where type = 'dormitory') as b on a.id = b.attendance_warnings_id where
        DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= date(a.created_at) GROUP BY xy
    </select>

</mapper>